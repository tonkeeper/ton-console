var x=Object.defineProperty;var T=(e,t,i)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var s=(e,t,i)=>T(e,typeof t!="symbol"?t+"":t,i);import{dq as q,dr as j,ds as l,dt as n,U as p,du as A,cy as _,r as c,j as a,O as Q,F as u,k as R,b as h,bM as y,dv as S,dw as b,dx as P}from"./index--6gyeIm1.js";import{L as w}from"./serialize-a49E7W4J.js";import{m as f}from"./analytics-query.store-BHruUl1l.js";import{m as F}from"./analytics-graph-query.store-dLjJUAwF.js";import{u as v}from"./useLocalObservable-BPr5Op9k.js";class O{constructor(t){s(this,"queries$",new w([]));s(this,"pagination",{filter:{onlyRepeating:!1}});s(this,"totalQueries",0);s(this,"pageSize",30);s(this,"disposers",[]);s(this,"isItemLoaded",t=>!this.hasNextPage||t<this.queries$.value.length);s(this,"loadFirstPage",this.queries$.createAsyncAction(async()=>{this.loadNextPage.cancelAllPendingCalls(),this.totalQueries=0;const{data:t,error:i}=await l({query:{project_id:this.project.id,limit:this.pageSize,offset:this.queries$.value.length,...this.pagination.filter.onlyRepeating&&{is_repetitive:!0},type:d(this.pagination.filter.type)}});if(i)throw i;const r=t.items.map(g);return this.totalQueries=t.count,r},{resetBeforeExecution:!0}));s(this,"loadNextPage",this.queries$.createAsyncAction(async()=>{const{data:t,error:i}=await l({query:{project_id:this.project.id,limit:this.pageSize,offset:this.queries$.value.length,...this.pagination.filter.onlyRepeating&&{is_repetitive:!0},type:d(this.pagination.filter.type)}});if(i)throw i;const r=t.items.map(g);return this.totalQueries=t.count,this.queries$.value.concat(r)}));s(this,"toggleFilterByType",t=>{var r,o;((r=this.pagination.filter.type)==null?void 0:r.includes(t))?this.pagination.filter.type=(o=this.pagination.filter.type)==null?void 0:o.filter(m=>m!==t):this.pagination.filter.type=(this.pagination.filter.type||[]).concat(t)});s(this,"toggleFilterByRepeating",()=>{this.pagination.filter.onlyRepeating=!this.pagination.filter.onlyRepeating});s(this,"clearFilterByType",()=>{this.pagination.filter.type=void 0});this.project=t,q(this),this.loadFirstPage();const i=j(()=>JSON.stringify(this.pagination),()=>{this.loadFirstPage({cancelPreviousCall:!0})});this.disposers.push(i)}get hasNextPage(){return this.queries$.value.length<this.totalQueries}get tableContentLength(){return this.hasNextPage?this.queries$.value.length+1:this.queries$.value.length}destroy(){this.disposers.forEach(t=>t==null?void 0:t()),this.disposers=[]}clearState(){this.queries$.clear()}}function g(e){var t;return e.type==="graph"?F(e):e.total_repetitions&&e.total_repetitions>1||(t=e.query)!=null&&t.repeat_interval?D(e):f(e)}function D(e){return{lastQuery:f(e),lastQueryDate:new Date(e.last_repeat_date),repeatFrequencyMs:e.query.repeat_interval*1e3,totalCost:e.total_usd_cost?new p(e.total_usd_cost):new p(0),totalRepetitions:e.total_repetitions}}function d(e){const t={sql:n.BASE_QUERY,graph:n.GRAPH,gpt:n.CHAT_GPT_QUERY};return e!=null&&e.length?e.map(i=>t[i]):void 0}const $=()=>{const e=_(),t=v(()=>new O(e));return c.useEffect(()=>{t.loadFirstPage()},[t]),c.useEffect(()=>()=>{t.destroy()},[t]),a.jsxs(Q,{display:"flex",flexDirection:"column",children:[a.jsxs(u,{align:"flex-start",justify:"space-between",gap:"3",mb:"5",children:[a.jsx(R,{children:"History"}),a.jsx(h,{as:y,ml:"auto",to:"../query",variant:"secondary",children:"New Query"}),a.jsx(h,{as:y,to:"../graph",variant:"secondary",children:"New Graph"})]}),a.jsxs(u,{align:"center",gap:"4",mb:"6",children:[a.jsx(S,{analyticsHistoryTableStore:t}),a.jsx(b,{analyticsHistoryTableStore:t})]}),a.jsx(P,{flex:"1",analyticsHistoryTableStore:t})]})},G=A($);export{G as default};
