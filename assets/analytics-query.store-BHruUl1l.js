var $=Object.defineProperty;var S=(r,e,t)=>e in r?$(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var n=(r,e,t)=>S(r,typeof e!="symbol"?e+"":e,t);import{dR as T,dS as g,dq as _,dT as b,dU as p,dV as Q,dA as m,dW as d,dz as f,bR as q,U as l,dX as w}from"./index--6gyeIm1.js";import{c as A}from"./useLocalObservable-BPr5Op9k.js";import{L as y}from"./serialize-a49E7W4J.js";const C=function(r,e={}){typeof r=="string"&&(r=T.from(r));const t=e&&e.objname?{}:[],s=g(e),i=u=>{s.options.objname===void 0?t.push(u):t[u[0]]=u[1]},o=()=>{},a=s.parse(r,!1,i,o);if(a!==void 0)throw a;const c=s.parse(void 0,!0,i,o);if(c!==void 0)throw c;return t};class F{constructor(e,t){n(this,"query$",new y(null));n(this,"chartsDatasource$",new y(null));n(this,"tablesSchema$",new y(void 0));n(this,"analyticsGPTGenerationStore");n(this,"disposers",[]);n(this,"fetchAllTablesSchema",this.tablesSchema$.createAsyncAction(async()=>{if(!this.tablesSchema$.value){const{data:e,error:t}=await b();if(t)throw t;return j(e)}},{resetBeforeExecution:!0}));n(this,"addChart",this.query$.createAsyncAction(async e=>{if(p(this.query$.value)){if(this.query$.value.charts.some(t=>t.type===e.type))throw new Error(`Chart ${e.type} already exists`);this.query$.value.charts.push(e)}}));n(this,"removeChart",this.query$.createAsyncAction(async e=>{p(this.query$.value)&&(this.query$.value.charts=this.query$.value.charts.filter(t=>t.type!==e))}));n(this,"createQuery",this.query$.createAsyncAction(async(e,t)=>{var a;const{data:s,error:i}=await Q({body:{project_id:this.project.id,query:e,...e.trim()===((a=this.analyticsGPTGenerationStore.generatedSQL$.value)==null?void 0:a.trim())&&{gpt_message:this.analyticsGPTGenerationStore.gptPrompt}},query:{chain:t==="testnet"?m.TESTNET:m.MAINNET}});return{data:i?void 0:h(s),error:i||void 0}},{errorToast:e=>({title:"Error",description:e.response.data.error})}));n(this,"setRepeatOnQuery",this.query$.createAsyncAction(async e=>{const{data:t,error:s}=await d({path:{id:this.query$.value.id},query:{project_id:this.project.id},body:{repeat_interval:e}});if(s)throw s;this.query$.value.repeatFrequencyMs=t.repeat_interval*1e3},{successToast:{title:"Query repeat interval updated successfully",status:"success",isClosable:!0},errorToast:e=>{var t,s;return{title:"Query repeat interval update error",description:((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.error)||"Unknown api error happened. Try again later",status:"error",isClosable:!0}}}));n(this,"setNameForQuery",this.query$.createAsyncAction(async e=>{const{error:t}=await d({path:{id:this.query$.value.id},query:{project_id:this.project.id},body:{name:e}});if(t)throw t;this.query$.value.name=e},{successToast:{title:"Query name updated successfully",status:"success",isClosable:!0},errorToast:e=>{var t,s;return{title:"Query name update error",description:((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.error)||"Unknown api error happened. Try again later",status:"error",isClosable:!0}}}));n(this,"removeRepeatOnQuery",this.query$.createAsyncAction(async()=>{const{error:e}=await d({path:{id:this.query$.value.id},query:{project_id:this.project.id},body:{repeat_interval:0}});if(e)throw e;delete this.query$.value.repeatFrequencyMs},{successToast:{title:"Query repeating stopped successfully",status:"success",isClosable:!0},errorToast:e=>{var t,s;return{title:"Query repeat interval update error",description:((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.error)||"Unknown api error happened. Try again later",status:"error",isClosable:!0}}}));n(this,"refetchQuery",this.query$.createAsyncAction(async()=>{const{data:e,error:t}=await f({path:{id:this.query$.value.id}});if(t)throw t;return h(e)}));n(this,"loadQuery",this.query$.createAsyncAction(async e=>{const{data:t,error:s}=await f({path:{id:e}});if(s)throw s;return h(t)},{resetBeforeExecution:!0}));n(this,"updateChartDatasource",this.chartsDatasource$.createAsyncAction(async()=>{if(p(this.query$.value))return D(this.query$.value.csvUrl)}));this.project=t,this.analyticsGPTGenerationStore=e,_(this);const s=A(()=>this.project,(o,a)=>{a&&this.clear()});this.disposers.push(s);const i=A(()=>{var o,a;return(((o=this.query$.value)==null?void 0:o.id)||"").toString()+(((a=this.query$.value)==null?void 0:a.status)||"").toString()},()=>{var o;this.updateChartDatasource.cancelAllPendingCalls(),((o=this.query$.value)==null?void 0:o.status)==="success"?this.updateChartDatasource():this.chartsDatasource$.setValue(null)});this.disposers.push(i)}get isQueryIntervalUpdateLoading(){return this.setRepeatOnQuery.isLoading||this.removeRepeatOnQuery.isLoading}destroy(){this.disposers.forEach(e=>e==null?void 0:e()),this.disposers=[]}clear(){this.query$.clear(),this.chartsDatasource$.clear()}}function h(r){var t,s,i;if(!r.estimate)throw new Error("Estimate is required");const e={type:"query",id:r.id,creationDate:new Date(r.date_create),gptPrompt:(t=r.query)==null?void 0:t.gpt_message,request:r.query.sql,estimatedTimeMS:r.estimate.approximate_time,estimatedCost:new l(r.estimate.approximate_usd_cost),explanation:r.estimate.explain,name:r.name,...((s=r.query)==null?void 0:s.repeat_interval)&&{repeatFrequencyMs:((i=r.query)==null?void 0:i.repeat_interval)*1e3},network:r.testnet?q.TESTNET:q.MAINNET};return r.status===w.EXECUTING?{...e,status:"executing"}:r.status===w.SUCCESS?{...e,status:"success",cost:new l(r.usd_cost),spentTimeMS:r.spent_time,csvUrl:r.url,preview:E(r.preview,!!r.all_data_in_preview),charts:[]}:{...e,status:"error",cost:new l(r.usd_cost),spentTimeMS:r.spent_time,errorReason:r.error}}function v(r){return/^[+-]?(\d+(\.\d*)?|\.\d+)$/.test(r.trim())}async function D(r){const t=await(await fetch(r)).text(),s=new Map,i=C(t,{columns:!0,skip_empty_lines:!0,cast(a,c){return v(a)?(s.has(c.column)||s.set(c.column,!0),parseFloat(a)):(s.set(c.column,!1),a)}}),o=Array.from(s.entries()).filter(([a,c])=>c).map(([a,c])=>a);return i.map(a=>Object.fromEntries(o.map(c=>[c,a[c]])))}function E(r,e){if(!r)return{headings:[],data:[],isAllDataPresented:!0};const t=r[0],s=r.slice(1);return{headings:t,data:s,isAllDataPresented:e}}function j(r){const e=/create table ([\w\.]+)\s*\(([\S\s]*?)\);/g,t=/(\s*([a-zA-Z0-9_]+) [^,]*,)/g;return Array.from(r.matchAll(e)).reduce((i,o)=>{const a=o[1],c=(o[2]+",").matchAll(t);return i[a]=Array.from(c).map(u=>u[2]),i},{})}export{F as A,h as m};
