var $=Object.defineProperty;var S=(r,e,t)=>e in r?$(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var n=(r,e,t)=>S(r,typeof e!="symbol"?e+"":e,t);import{d2 as T,d3 as g,cz as _,cB as p,d4 as b,d5 as l,d6 as Q,cL as m,d7 as y,cI as f,cK as q,b2 as d,d8 as w}from"./index-BCN26Ft_.js";import{c as A}from"./create-reaction-CzXnGxB7.js";const C=function(r,e={}){typeof r=="string"&&(r=T.from(r));const t=e&&e.objname?{}:[],s=g(e),o=u=>{s.options.objname===void 0?t.push(u):t[u[0]]=u[1]},i=()=>{},a=s.parse(r,!1,o,i);if(a!==void 0)throw a;const c=s.parse(void 0,!0,o,i);if(c!==void 0)throw c;return t};class F{constructor(e,t){n(this,"query$",new p(null));n(this,"chartsDatasource$",new p(null));n(this,"tablesSchema$",new p(void 0));n(this,"analyticsGPTGenerationStore");n(this,"disposers",[]);n(this,"fetchAllTablesSchema",this.tablesSchema$.createAsyncAction(async()=>{if(!this.tablesSchema$.value){const{data:e,error:t}=await b();if(t)throw t;return j(e)}},{resetBeforeExecution:!0}));n(this,"addChart",this.query$.createAsyncAction(async e=>{if(l(this.query$.value)){if(this.query$.value.charts.some(t=>t.type===e.type))throw new Error(`Chart ${e.type} already exists`);this.query$.value.charts.push(e)}}));n(this,"removeChart",this.query$.createAsyncAction(async e=>{l(this.query$.value)&&(this.query$.value.charts=this.query$.value.charts.filter(t=>t.type!==e))}));n(this,"createQuery",this.query$.createAsyncAction(async(e,t)=>{var i;const{data:s,error:o}=await Q({body:{project_id:this.project.id,query:e,...e.trim()===((i=this.analyticsGPTGenerationStore.generatedSQL$.value)==null?void 0:i.trim())&&{gpt_message:this.analyticsGPTGenerationStore.gptPrompt}},query:{chain:t==="testnet"?m.TESTNET:m.MAINNET}});if(o)throw o;return h(s)},{errorToast:e=>({title:"Error",description:e.response.data.error})}));n(this,"setRepeatOnQuery",this.query$.createAsyncAction(async e=>{const{data:t,error:s}=await y({path:{id:this.query$.value.id},query:{project_id:this.project.id},body:{repeat_interval:e}});if(s)throw s;this.query$.value.repeatFrequencyMs=t.repeat_interval*1e3},{successToast:{title:"Query repeat interval updated successfully",status:"success",isClosable:!0},errorToast:e=>{var t,s;return{title:"Query repeat interval update error",description:((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.error)||"Unknown api error happened. Try again later",status:"error",isClosable:!0}}}));n(this,"setNameForQuery",this.query$.createAsyncAction(async e=>{const{error:t}=await y({path:{id:this.query$.value.id},query:{project_id:this.project.id},body:{name:e}});if(t)throw t;this.query$.value.name=e},{successToast:{title:"Query name updated successfully",status:"success",isClosable:!0},errorToast:e=>{var t,s;return{title:"Query name update error",description:((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.error)||"Unknown api error happened. Try again later",status:"error",isClosable:!0}}}));n(this,"removeRepeatOnQuery",this.query$.createAsyncAction(async()=>{const{error:e}=await y({path:{id:this.query$.value.id},query:{project_id:this.project.id},body:{repeat_interval:0}});if(e)throw e;delete this.query$.value.repeatFrequencyMs},{successToast:{title:"Query repeating stopped successfully",status:"success",isClosable:!0},errorToast:e=>{var t,s;return{title:"Query repeat interval update error",description:((s=(t=e.response)==null?void 0:t.data)==null?void 0:s.error)||"Unknown api error happened. Try again later",status:"error",isClosable:!0}}}));n(this,"refetchQuery",this.query$.createAsyncAction(async()=>{const{data:e,error:t}=await f({path:{id:this.query$.value.id}});if(t)throw t;return h(e)}));n(this,"loadQuery",this.query$.createAsyncAction(async e=>{const{data:t,error:s}=await f({path:{id:e}});if(s)throw s;return h(t)},{resetBeforeExecution:!0}));n(this,"updateChartDatasource",this.chartsDatasource$.createAsyncAction(async()=>{if(l(this.query$.value))return v(this.query$.value.csvUrl)}));this.project=t,this.analyticsGPTGenerationStore=e,_(this);const s=A(()=>this.project,(i,a)=>{a&&this.clear()});this.disposers.push(s);const o=A(()=>{var i,a;return(((i=this.query$.value)==null?void 0:i.id)||"").toString()+(((a=this.query$.value)==null?void 0:a.status)||"").toString()},()=>{var i;this.updateChartDatasource.cancelAllPendingCalls(),((i=this.query$.value)==null?void 0:i.status)==="success"?this.updateChartDatasource():this.chartsDatasource$.setValue(null)});this.disposers.push(o)}get isQueryIntervalUpdateLoading(){return this.setRepeatOnQuery.isLoading||this.removeRepeatOnQuery.isLoading}destroy(){this.disposers.forEach(e=>e==null?void 0:e()),this.disposers=[]}clear(){this.query$.clear(),this.chartsDatasource$.clear()}}function h(r){var t,s,o;const e={type:"query",id:r.id,creationDate:new Date(r.date_create),gptPrompt:(t=r.query)==null?void 0:t.gpt_message,request:r.query.sql,estimatedTimeMS:r.estimate.approximate_time,estimatedCost:new d(r.estimate.approximate_cost),explanation:r.estimate.explain,name:r.name,...((s=r.query)==null?void 0:s.repeat_interval)&&{repeatFrequencyMs:((o=r.query)==null?void 0:o.repeat_interval)*1e3},network:r.testnet?q.TESTNET:q.MAINNET};return r.status===w.EXECUTING?{...e,status:"executing"}:r.status===w.SUCCESS?{...e,status:"success",cost:new d(r.cost),spentTimeMS:r.spent_time,csvUrl:r.url,preview:E(r.preview,!!r.all_data_in_preview),charts:[]}:{...e,status:"error",cost:new d(r.cost),spentTimeMS:r.spent_time,errorReason:r.error}}function D(r){return/^[+-]?(\d+(\.\d*)?|\.\d+)$/.test(r.trim())}async function v(r){const t=await(await fetch(r)).text(),s=new Map,o=C(t,{columns:!0,skip_empty_lines:!0,cast(a,c){return D(a)?(s.has(c.column)||s.set(c.column,!0),parseFloat(a)):(s.set(c.column,!1),a)}}),i=Array.from(s.entries()).filter(([a,c])=>c).map(([a,c])=>a);return o.map(a=>Object.fromEntries(i.map(c=>[c,a[c]])))}function E(r,e){if(!r)return{headings:[],data:[],isAllDataPresented:!0};const t=r[0],s=r.slice(1);return{headings:t,data:s,isAllDataPresented:e}}function j(r){const e=/create table ([\w\.]+)\s*\(([\S\s]*?)\);/g,t=/(\s*([a-zA-Z0-9_]+) [^,]*,)/g;return Array.from(r.matchAll(e)).reduce((o,i)=>{const a=i[1],c=(i[2]+",").matchAll(t);return o[a]=Array.from(c).map(u=>u[2]),o},{})}export{F as A,h as m};
