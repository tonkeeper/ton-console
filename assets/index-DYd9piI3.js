var z=Object.defineProperty;var U=(r,e,s)=>e in r?z(r,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[e]=s;var a=(r,e,s)=>U(r,typeof e!="symbol"?e+"":e,s);import{cz as O,cB as E,cK as y,cL as g,cM as F,b2 as G,cN as K,cO as V,cP as Y,K as H,c8 as J,r as p,cy as W,j as t,O as X,F as Q,k as Z,N as ee,cQ as te,o as P,cl as se,R as re,U as I,a0 as v,d as ae,c0 as ne,cR as $,B as ce,cS as ie,cT as oe,C as le,G as ue}from"./index-BCN26Ft_.js";import{u as de}from"./useSearchParams-BuN13fRl.js";import{A as he}from"./ANALYTICS_LINKS-WaHD7Hyc.js";import{A as pe}from"./analytics-query.store-BitVLp-P.js";import{c as xe,u as T}from"./create-reaction-CzXnGxB7.js";import{T as ye,a as fe,b as L,c as me,d as M}from"./tab-panels-BFaL-foB.js";class _{constructor(e){a(this,"request$",new E(null));a(this,"_network",y.MAINNET);a(this,"disposers",[]);a(this,"estimateRequest",this.request$.createAsyncAction(async({request:e,name:s,network:h})=>{var c,f,m;try{const n=(h||this.network)===y.TESTNET?g.TESTNET:g.MAINNET,{data:x,error:j}=await F({body:{project_id:this.project.id,query:e,name:s},query:{chain:n}});if(j)throw j;const q=we(e,n,x);return this.request$.value=q,q}catch(n){const x=((m=(f=(c=n==null?void 0:n.response)==null?void 0:c.data)==null?void 0:f.error)==null?void 0:m.toString())||"Unknown error";throw new Error(x)}}));a(this,"setNetwork",this.request$.createAsyncAction(async e=>{this.estimateRequest.cancelAllPendingCalls(),this._network=e,this.request$.value&&this.request$.value.network!==e&&await this.estimateRequest({request:this.request$.value.request,network:e})}));a(this,"setRequest",e=>{this.request$.clear(e),this._network=e.network,this.request$.state="ready"});this.project=e,O(this);const s=xe(()=>this.project,(h,c)=>{c&&this.clear()});this.disposers.push(s)}get network(){return this._network}destroy(){this.disposers.forEach(e=>e==null?void 0:e()),this.disposers=[]}clear(){this.estimateRequest.cancelAllPendingCalls(),this.request$.clear()}clearRequest(){this.estimateRequest.cancelAllPendingCalls(),this.request$.clear()}}function we(r,e,s){return{request:r,network:K[e],estimatedTimeMS:s.approximate_time,estimatedCost:new G(s.approximate_cost),explanation:s.explain}}class je{constructor(e){a(this,"generatedSQL$",new E(null));a(this,"gptPricing$",new E(null));a(this,"gptPrompt","");a(this,"disposers",[]);a(this,"fetchPrice",this.gptPricing$.createAsyncAction(async()=>{const{data:e,error:s}=await V({query:{project_id:this.project.id}});if(s)throw s;return qe(e)}));a(this,"generateSQL",this.generatedSQL$.createAsyncAction(async(e,s)=>{const{data:h,error:c}=await Y({query:{project_id:this.project.id},body:{message:e,context:s}});if(c)throw c;return await this.fetchPrice(),h.message}));this.project=e,O(this),e.capabilities.stats.query&&this.fetchPrice()}destroy(){this.disposers.forEach(e=>e==null?void 0:e()),this.disposers=[]}clear(){this.generateSQL.cancelAllPendingCalls(),this.generatedSQL$.clear(),this.gptPrompt=""}}function qe(r){return{freeRequestsNumber:r.free_requests,usedFreeRequest:r.used,requestPrice:r.price?new G(r.price):r.usd_price}}const Ee=()=>{const r=H(),{searchParams:e,updateSearchParams:s}=de(),h=e.get("id"),c=e.get("type"),f=e.get("network"),m=e.get("query"),n=J(),x=(m&&decodeURIComponent(m))??void 0,[j]=p.useState(c==="gpt"?x:void 0),[q]=p.useState(c!=="gpt"?x:void 0),[D,S]=p.useState(!1),i=T(()=>new je(n)),o=T(()=>new pe(i,n)),l=T(()=>new _(n)),u=T(()=>new _(n));p.useEffect(()=>{o.fetchAllTablesSchema(),i.clear(),h?(S(!1),o.loadQuery(h).then(d=>{l.setRequest(d),S(!0)}).catch(()=>s({id:null,type:"sql"}))):(o.clear(),l.clear(),S(!0)),s({query:null})},[h,s]),p.useEffect(()=>{const d=f,w=Object.values(y).includes(d)?d:y.MAINNET;l.setNetwork(w),u.setNetwork(w)},[f]);const A=n.id,N=W(A),R=c==="gpt"?1:0,B=d=>s({type:d===1?"gpt":"sql"}),k=(R===0?l:u).network;return p.useEffect(()=>{N!==void 0&&A!==N&&r("../history")},[N,A]),p.useEffect(()=>()=>{var d,b,w,C;(d=o.destroy)==null||d.call(o),(b=i.destroy)==null||b.call(i),(w=l.destroy)==null||w.call(l),(C=u.destroy)==null||C.call(u)},[o,i,l,u]),t.jsxs(X,{display:"flex",flexDirection:"column",children:[t.jsxs(Q,{align:"center",gap:"3",mb:"4",children:[t.jsx(Z,{children:"New Request"}),t.jsxs(ee,{placement:"bottom",children:[t.jsx(te,{variant:"flat","aria-label":"network",rightIcon:t.jsx(se,{}),textStyle:"label2",color:"text.secondary",children:t.jsx(P,{textTransform:"capitalize",children:k})}),t.jsxs(re,{w:"122px",children:[t.jsxs(I,{gap:"2",onClick:()=>s({network:g.MAINNET}),children:[t.jsx(P,{textStyle:"label2",children:"Mainnet"}),k===y.MAINNET&&t.jsx(v,{})]}),t.jsxs(I,{gap:"2",onClick:()=>s({network:g.TESTNET}),children:[t.jsx(P,{textStyle:"label2",children:"Testnet"}),k===y.TESTNET&&t.jsx(v,{})]})]})]})]}),D?t.jsxs(Q,{pos:"relative",direction:"column",children:[t.jsx(ae,{pos:"absolute",top:"-13px",right:"0",leftIcon:t.jsx(ne,{w:"20px",h:"20px"}),size:"sm",variant:"secondary",zIndex:"3",href:he.QUERY.INTRO,isExternal:!0,children:"Console Docs"}),t.jsxs(ye,{flexDir:"column",flex:"1",display:"flex",mb:"6",index:R,onChange:B,children:[t.jsxs(fe,{w:"auto",mx:"-24px",px:"6",children:[t.jsx(L,{children:"SQL"}),t.jsx(L,{children:"ChatGPT"})]}),t.jsxs(me,{children:[t.jsx(M,{flex:"1",children:t.jsx($,{flex:"1",type:"sql",defaultRequest:q,analyticsQueryStore:o,analyticsQuerySQLRequestStore:l,analyticsQueryGPTRequestStore:u,analyticsGPTGenerationStore:i})}),t.jsx(M,{flex:"1",children:t.jsxs(ce,{w:"100%",children:[t.jsx(ie,{mb:"5",defaultRequest:j,analyticsGPTGenerationStore:i,analyticsQueryGPTRequestStore:u}),!!i.generatedSQL$.value&&t.jsx($,{flex:"1",type:"gpt",analyticsQueryStore:o,analyticsQuerySQLRequestStore:l,analyticsQueryGPTRequestStore:u,analyticsGPTGenerationStore:i})]})})]})]}),t.jsx(oe,{flex:"1",analyticsQueryStore:o})]}):t.jsx(le,{h:"300px",children:t.jsx(ue,{})})]})};export{Ee as default};
