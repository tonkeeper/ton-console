import{q,aT as $,a3 as K,v as z,aU as G,bp as J,bq as X,br as Y,bs as Z,Q as D,bt as L,a$ as E,bu as ee,r as f,bv as U,j as e,aK as te,b1 as B,bw as P,bx as se,by as M,bz as ne,bA as re,o as d,b3 as N,F as b,S as ae,bB as oe,bC as ie,bD as le,ay as ce,az as ue,aA as de,aC as xe,aB as me,aD as he,bE as pe,bF as be,B as g,b4 as ye,b as F,l as I,bG as fe,bm as O,U as je,bk as ge,O as we,k as Ae,D as Ce,bH as Se,bI as Te,N as ve,R as Fe}from"./index--6gyeIm1.js";import{t as Re}from"./explorer-CZ4ocQ7V.js";import{t as ke}from"./ton-mask-eMbmeoGa.js";import{C as Be}from"./card-Csp8xPXk.js";import{C as Pe}from"./card-body-B5KnP0ef.js";function Me(n){return{tonSupply:new D(n.balance),tonRate:n.usd_per_testnet_ton}}async function H(n,r=0){return X.blockchain.getBlockchainTransactionByMessageHash(n).then(s=>s.hash).catch(s=>{if(Y(s,"message")&&s.message==="transaction not found"){if(r>20)throw new Error("Tx not found");return new Promise(t=>setTimeout(t,1500)).then(()=>H(n,r+1))}throw s})}function Ne(){const n=q();return $({queryKey:["faucet-supply-rate",n||void 0],queryFn:async()=>{const{data:r,error:s}=await Z();if(s)throw s;return Me(r)},enabled:!!n,refetchInterval:30*1e3,staleTime:30*1e3})}function Ie(){const n=K(),r=q(),s=z();return G({mutationFn:async t=>{const a=r;if(!a)throw new Error("Project not selected");const{data:c,error:o}=await J({query:{project_id:a},body:{address:t.receiverAddress,coins:t.amount.weiAmount.toNumber()}});if(o)throw o;const i=await H(c.hash);return await n.invalidateQueries({queryKey:["faucet-supply-rate",a]}),{amount:t.amount,link:Re.transactionLink(i),_projectId:a}},onSuccess:t=>{s({title:"Successfully bought testnet assets",status:"success",isClosable:!0,duration:3e3})},onError:t=>{var i,x;let a="Unknown error",c="Unknown api error happened. Try again later";const o=t;((x=(i=o==null?void 0:o.response)==null?void 0:i.data)==null?void 0:x.code)===3&&(a="Only one request per minute is allowed",c="Please wait few minutes and try again"),s({title:a,description:c,status:"error",isClosable:!0,duration:3e3})}})}const Oe=({id:n,onSubmit:r,disableDefaultFocus:s,tonLimit:t,isDisabled:a,...c})=>{var y;const o=l=>{r({amount:D.fromRelativeAmount(l.tonAmount),receiverAddress:ie.Address.parse(l.address).toRawString()})},i=L();let{handleSubmit:x,register:j,setFocus:p,formState:{errors:u}}=E({defaultValues:{tonAmount:void 0}});i&&({handleSubmit:x,register:j,setFocus:p,formState:{errors:u}}=i);const{ref:m}=ee({...ke,min:0,max:t==null?void 0:t.amount.toNumber()});f.useEffect(()=>{s||p("tonAmount")},[s,p]);const{ref:C,...S}=j("tonAmount",{required:"This is required",validate:l=>{if(!U(l))return"Wrong amount format";if(Number(l)<1)return"Amount must be greater than 1";if(!t)return"Wait until total supply will be loaded";if(t.amount.lt(l))return`Not enough testnet coins supply. Max is ${t.amount.toNumber()}`}});return e.jsx(te.form,{id:n,onSubmit:x(o),noValidate:!0,...c,children:e.jsxs("fieldset",{disabled:a,children:[e.jsxs(B,{mb:"4",isInvalid:!!u.tonAmount,isRequired:!0,children:[e.jsx(P,{htmlFor:"tonAmount",children:"Amount"}),e.jsxs(se,{children:[e.jsx(M,{ref:ne(m,C),pr:"130px",autoComplete:"off",id:"tonAmount",placeholder:"1",...S}),e.jsx(re,{w:"130px",children:e.jsx(d,{textStyle:"body2",color:"text.secondary",children:"TON (testnet)"})})]}),e.jsx(N,{pos:"static",children:u.tonAmount&&u.tonAmount.message}),e.jsxs(b,{textStyle:"body3",gap:"1",mt:(y=u.tonAmount)!=null&&y.message?"1":"2",children:[e.jsx(d,{color:"text.secondary",children:"Max.available for buy:"}),e.jsxs(ae,{minW:"80px",h:"18px",isLoaded:!!t,children:[t==null?void 0:t.stringCurrencyAmount," (testnet)"]})]})]}),e.jsxs(B,{mb:"0",isInvalid:!!u.address,isRequired:!0,children:[e.jsx(P,{htmlFor:"address",children:"Recipient testnet address"}),e.jsx(M,{autoComplete:"off",id:"address",placeholder:"Address",...j("address",{required:"This is required",validate:l=>{if(!oe(l,{acceptTestnet:!0,acceptRaw:!0}))return"Wrong address"}})}),e.jsx(N,{pos:"static",children:u.address&&u.address.message})]})]})})},qe=({isOpen:n,onClose:r,amount:s,receiverAddress:t,price:a,isLoading:c,onConfirm:o})=>{const i=t?le(t,{testOnly:!0,bounceable:!1}):"",x=f.useCallback(()=>{o&&s&&t&&o({amount:s,receiverAddress:t})},[o,s,t]);return e.jsxs(ce,{isOpen:n,onClose:r,scrollBehavior:"inside",children:[e.jsx(ue,{}),e.jsxs(de,{children:[e.jsx(xe,{}),e.jsx(me,{children:"Payment Details"}),e.jsx(he,{children:e.jsx(Be,{children:e.jsxs(Pe,{textStyle:"body2",flexDir:"column",gap:"3",display:"flex",px:"6",py:"5",children:[e.jsxs(b,{align:"center",justify:"space-between",children:[e.jsx(d,{color:"text.secondary",children:"Amount"}),e.jsxs(d,{children:[s==null?void 0:s.stringCurrencyAmount," (testnet)"]})]}),e.jsxs(b,{align:"center",justify:"space-between",children:[e.jsx(d,{color:"text.secondary",children:"Recipient testnet address"}),e.jsx(d,{children:e.jsx(pe,{canBeShown:!0,host:e.jsx(d,{children:be(i)}),children:i})})]}),e.jsxs(b,{align:"flex-start",justify:"space-between",children:[e.jsx(d,{color:"text.secondary",children:"Price"}),a&&e.jsxs(g,{textAlign:"right",children:[e.jsx(d,{children:a.stringCurrencyAmount}),e.jsx(g,{color:"text.secondary",children:"USD"})]})]})]})})}),e.jsxs(ye,{gap:"3",children:[e.jsx(F,{flex:1,onClick:r,variant:"secondary",children:"Cancel"}),e.jsx(F,{flex:1,isLoading:c,onClick:x,variant:"primary",children:"Confirm Purchase"})]})]})]})},_e=()=>{const{isOpen:n,onClose:r,onOpen:s}=I(),{isOpen:t,onClose:a,onOpen:c}=I(),[o,i]=f.useState(""),[x,j]=f.useState(void 0),[p,u]=f.useState(null),{data:m,refetch:C}=Ne(),{mutate:S,isPending:y}=Ie();fe(C);const l=f.useId(),R=E(),{watch:W}=R,w=W("tonAmount"),T=(m==null?void 0:m.tonRate)??0,_=new O(T);let h;m&&U(w)&&Number(w)&&Number(w)>=.01&&(h=new je(new O(Number(w)).multipliedBy(_)));const v=ge((h==null?void 0:h.amount)||null,{includePromo:!1,onlyUsdt:!0}),Q=A=>{if(i(A.receiverAddress),j(A.amount),h&&(v!=null&&v.canPay))return s();c()},V=A=>{S(A,{onSuccess:k=>{u({amount:k.amount,link:k.link}),r()}})};return e.jsxs(we,{h:"fit-content",children:[e.jsxs(b,{align:"center",justify:"space-between",wrap:"wrap",gap:"4",maxW:"512px",children:[e.jsx(Ae,{mb:"2",children:"Testnet Assets"}),e.jsx(d,{textStyle:"label2",color:"text.tertiary",alignContent:"center",children:"Promo balance cannot be used to purchase assets"})]}),e.jsx(Ce,{w:"auto",mx:"-6",mb:"4"}),e.jsxs(g,{maxW:"512px",children:[e.jsx(Se,{...R,children:e.jsx(Oe,{id:l,tonLimit:(m==null?void 0:m.tonSupply)||void 0,onSubmit:Q,isDisabled:y,mb:"6",w:"100%"})}),e.jsxs(b,{align:"center",justify:"space-between",gap:"4",w:"100%",children:[e.jsx(b,{align:"center",wrap:"wrap",gap:"4",children:e.jsx(F,{form:l,isLoading:y,type:"submit",children:h?`Buy for ${h.stringCurrencyAmount}`:"Buy Testnet TON"})}),T>0&&e.jsxs(g,{textStyle:"label2",color:"text.secondary",textAlign:"right",children:["1 testnet TON = $",Te(T,{decimalPlaces:2})]}),p&&e.jsxs(g,{textStyle:"label2",ml:"auto",color:"text.secondary",textAlign:"right",children:["Bought ",p.amount.stringAmount," testnet TON"," ",e.jsx(ve,{textStyle:"label2",color:"text.accent",href:p.link,isExternal:!0,children:"View in explorer"})]})]})]}),e.jsx(qe,{isOpen:n,onClose:r,price:h,amount:x,receiverAddress:o,onConfirm:V,isLoading:y}),e.jsx(Fe,{isOpen:t,onClose:a})]})};export{_e as default};
