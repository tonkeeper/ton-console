var U=Object.defineProperty;var F=(r,e,s)=>e in r?U(r,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[e]=s;var a=(r,e,s)=>F(r,typeof e!="symbol"?e+"":e,s);import{dq as D,bR as y,dA as g,dB as z,U as G,dC as V,dD as H,dE as Y,X as K,cy as X,r as p,dp as Z,j as t,O as J,F as I,k as W,Z as ee,d4 as te,o as E,cN as se,$ as re,a0 as Q,a5 as v,d as ae,ce as ne,dF as $,B as ie,dG as oe,dH as ce,C as le,V as ue}from"./index--6gyeIm1.js";import{u as de}from"./useSearchParams-C4KxjW47.js";import{A as he}from"./ANALYTICS_LINKS-WaHD7Hyc.js";import{A as pe}from"./analytics-query.store-BHruUl1l.js";import{c as xe,u as T}from"./useLocalObservable-BPr5Op9k.js";import{L as P}from"./serialize-a49E7W4J.js";import{T as ye,a as me,b as L,c as fe,d as _}from"./tab-panels-DLu8u9kl.js";class M{constructor(e){a(this,"request$",new P(null));a(this,"_network",y.MAINNET);a(this,"disposers",[]);a(this,"estimateRequest",this.request$.createAsyncAction(async({request:e,name:s,network:h})=>{var i,m,f;try{const n=(h||this.network)===y.TESTNET?g.TESTNET:g.MAINNET,{data:x,error:j}=await z({body:{project_id:this.project.id,query:e,name:s},query:{chain:n}});if(j)throw j;const q=we(e,n,x);return this.request$.value=q,q}catch(n){const x=((f=(m=(i=n==null?void 0:n.response)==null?void 0:i.data)==null?void 0:m.error)==null?void 0:f.toString())||"Unknown error";throw new Error(x)}}));a(this,"setNetwork",this.request$.createAsyncAction(async e=>{this.estimateRequest.cancelAllPendingCalls(),this._network=e,this.request$.value&&this.request$.value.network!==e&&await this.estimateRequest({request:this.request$.value.request,network:e})}));a(this,"setRequest",e=>{this.request$.clear(e),this._network=e.network,this.request$.state="ready"});this.project=e,D(this);const s=xe(()=>this.project,(h,i)=>{i&&this.clear()});this.disposers.push(s)}get network(){return this._network}destroy(){this.disposers.forEach(e=>e==null?void 0:e()),this.disposers=[]}clear(){this.estimateRequest.cancelAllPendingCalls(),this.request$.clear()}clearRequest(){this.estimateRequest.cancelAllPendingCalls(),this.request$.clear()}}function we(r,e,s){return{request:r,network:V[e],estimatedTimeMS:s.approximate_time,estimatedCost:new G(s.approximate_usd_cost),explanation:s.explain}}class je{constructor(e){a(this,"generatedSQL$",new P(null));a(this,"gptPricing$",new P(null));a(this,"gptPrompt","");a(this,"disposers",[]);a(this,"fetchPrice",this.gptPricing$.createAsyncAction(async()=>{const{data:e,error:s}=await H({query:{project_id:this.project.id}});if(s)throw s;return qe(e)}));a(this,"generateSQL",this.generatedSQL$.createAsyncAction(async(e,s)=>{const{data:h,error:i}=await Y({query:{project_id:this.project.id},body:{message:e,context:s}});if(i)throw i;return await this.fetchPrice(),h.message}));this.project=e,D(this),e.capabilities.stats.query&&this.fetchPrice()}destroy(){this.disposers.forEach(e=>e==null?void 0:e()),this.disposers=[]}clear(){this.generateSQL.cancelAllPendingCalls(),this.generatedSQL$.clear(),this.gptPrompt=""}}function qe(r){return{freeRequestsNumber:r.free_requests,usedFreeRequest:r.used,requestPrice:new G(r.usd_price)}}const Ce=()=>{const r=K(),{searchParams:e,updateSearchParams:s}=de(),h=e.get("id"),i=e.get("type"),m=e.get("network"),f=e.get("query"),n=X(),x=(f&&decodeURIComponent(f))??void 0,[j]=p.useState(i==="gpt"?x:void 0),[q]=p.useState(i!=="gpt"?x:void 0),[O,A]=p.useState(!1),o=T(()=>new je(n)),c=T(()=>new pe(o,n)),l=T(()=>new M(n)),u=T(()=>new M(n));p.useEffect(()=>{c.fetchAllTablesSchema(),o.clear(),h?(A(!1),c.loadQuery(h).then(d=>{l.setRequest(d),A(!0)}).catch(()=>s({id:null,type:"sql"}))):(c.clear(),l.clear(),A(!0)),s({query:null})},[h,s]),p.useEffect(()=>{const d=m,w=Object.values(y).includes(d)?d:y.MAINNET;l.setNetwork(w),u.setNetwork(w)},[m]);const S=n.id,N=Z(S),C=i==="gpt"?1:0,B=d=>s({type:d===1?"gpt":"sql"}),k=(C===0?l:u).network;return p.useEffect(()=>{N!==void 0&&S!==N&&r("../history")},[N,S]),p.useEffect(()=>()=>{var d,b,w,R;(d=c.destroy)==null||d.call(c),(b=o.destroy)==null||b.call(o),(w=l.destroy)==null||w.call(l),(R=u.destroy)==null||R.call(u)},[c,o,l,u]),t.jsxs(J,{display:"flex",flexDirection:"column",children:[t.jsxs(I,{align:"center",gap:"3",mb:"4",children:[t.jsx(W,{children:"New Request"}),t.jsxs(ee,{placement:"bottom",children:[t.jsx(te,{variant:"flat","aria-label":"network",rightIcon:t.jsx(se,{}),textStyle:"label2",color:"text.secondary",children:t.jsx(E,{textTransform:"capitalize",children:k})}),t.jsxs(re,{w:"122px",children:[t.jsxs(Q,{gap:"2",onClick:()=>s({network:g.MAINNET}),children:[t.jsx(E,{textStyle:"label2",children:"Mainnet"}),k===y.MAINNET&&t.jsx(v,{})]}),t.jsxs(Q,{gap:"2",onClick:()=>s({network:g.TESTNET}),children:[t.jsx(E,{textStyle:"label2",children:"Testnet"}),k===y.TESTNET&&t.jsx(v,{})]})]})]})]}),O?t.jsxs(I,{pos:"relative",direction:"column",children:[t.jsx(ae,{pos:"absolute",top:"-13px",right:"0",leftIcon:t.jsx(ne,{w:"20px",h:"20px"}),size:"sm",variant:"secondary",zIndex:"3",href:he.QUERY.INTRO,isExternal:!0,children:"Console Docs"}),t.jsxs(ye,{flexDir:"column",flex:"1",display:"flex",mb:"6",index:C,onChange:B,children:[t.jsxs(me,{w:"auto",mx:"-24px",px:"6",children:[t.jsx(L,{children:"SQL"}),t.jsx(L,{children:"ChatGPT"})]}),t.jsxs(fe,{children:[t.jsx(_,{flex:"1",children:t.jsx($,{flex:"1",type:"sql",defaultRequest:q,analyticsQueryStore:c,analyticsQuerySQLRequestStore:l,analyticsQueryGPTRequestStore:u,analyticsGPTGenerationStore:o})}),t.jsx(_,{flex:"1",children:t.jsxs(ie,{w:"100%",children:[t.jsx(oe,{mb:"5",defaultRequest:j,analyticsGPTGenerationStore:o,analyticsQueryGPTRequestStore:u}),!!o.generatedSQL$.value&&t.jsx($,{flex:"1",type:"gpt",analyticsQueryStore:c,analyticsQuerySQLRequestStore:l,analyticsQueryGPTRequestStore:u,analyticsGPTGenerationStore:o})]})})]})]}),t.jsx(ce,{flex:"1",analyticsQueryStore:c})]}):t.jsx(le,{h:"300px",children:t.jsx(ue,{})})]})};export{Ce as default};
