import{r as l,q as Y,j as e,F as p,b$ as Q,T as C,by as X,b as _,e2 as J,es as z,bC as F,du as q,v as G,ey as Z,ez as ee,em as te,en as ae,C as B,V as O,k as V,ev as ne,O as oe,B as se,bN as re,eo as ie,D as le}from"./index--6gyeIm1.js";import{d as ce}from"./airdrop.store-BCJp4K4U.js";import{F as de,a as ue,I as pe}from"./UtilsComponents-CpKHSN7E.js";import{C as me}from"./index-Dfsp2eQr.js";import{C as fe}from"./card-Csp8xPXk.js";import"./serialize-a49E7W4J.js";import"./copy-to-clipboard-Ct1_m45i.js";const xe=t=>{const[o,n]=l.useState(!1),[a,r]=l.useState(null),[m,c]=l.useState(null),[i,d]=l.useState(!1),[s,j]=l.useState(!1),[x,k]=l.useState(null),f=Y(),T=l.useRef(null),S=l.useRef(null),I=t.airdropStore,w=I.airdrop$.value,A=()=>{T.current&&clearInterval(T.current)};l.useEffect(()=>(o?A():T.current=setInterval(async()=>{await I.loadAirdrop(t.id)},2e3),()=>A()),[o]),l.useEffect(()=>{w.upload_error&&(r(w.upload_error),d(!1)),(w.upload_in_progress||w.file_hash)&&d(!0)},[w]);const b=async u=>{n(!0),r(null),await J.v1.fileUpload({id:t.id,project_id:`${f}`},{file:u},{onUploadProgress:h=>{if(h.total){const D=Math.round(h.loaded/h.total*100);c(D)}}}).catch(h=>{r(h==null?void 0:h.message)}).finally(async()=>{await I.loadAirdrop(t.id),n(!1),c(null),S.current&&(S.current.value="")})},L=async()=>{n(!0),r(null);try{new URL(x)}catch{r("Incorrect file URL")}await J.v2.fileUpload({id:t.id,project_id:`${f}`},{url:x}).catch(u=>{r(u==null?void 0:u.message)}).finally(async()=>{await I.loadAirdrop(t.id),n(!1)})},v=async u=>{if(u.type!=="text/csv"&&!u.name.endsWith(".csv")){r("Invalid file type");return}if(u.size<1e3){r("Minimum 20 wallets");return}if(u.size>104857600){r("Maximum 100 MB");return}await b(u)};return e.jsxs(p,{direction:"column",gap:"16px",children:[i&&e.jsx(de,{}),!i&&e.jsxs(p,{direction:"column",gap:"24px",children:[e.jsxs(p,{direction:"column",gap:"16px",children:[e.jsx(Q,{checked:s,onChange:()=>j(!s),children:e.jsx(C,{textStyle:"label2",children:"File size more than 100 MB"})}),s?e.jsxs(p,{direction:"column",gap:"12px",children:[e.jsxs(p,{align:"center",direction:"row",gap:"12px",children:[e.jsx(X,{autoComplete:"off",onChange:u=>k(u.target.value),placeholder:"File URL",value:x||""}),e.jsx(_,{flexShrink:0,isDisabled:!x,isLoading:o,onClick:L,children:"Upload File"})]}),!!a&&e.jsx(C,{textStyle:"body2",color:"#F53C36",children:a})]}):e.jsxs(e.Fragment,{children:[e.jsxs(p,{align:"center",direction:"row",gap:"12px",children:[e.jsx(_,{flexShrink:0,isLoading:o,onClick:()=>{r(null),S.current.click()},children:"Upload File"}),!!m&&e.jsxs(p,{direction:"column",flex:1,gap:"4px",children:[e.jsx(p,{flex:1,overflow:"hidden",h:"8px",minH:"8px",borderRadius:"8px",bgColor:"background.contentTint",children:e.jsx(p,{w:`${m}%`,h:"8px",bgColor:"#000"})}),e.jsxs(C,{textStyle:"body3",color:"text.secondary",children:[m,"% of the file uploaded"]})]}),!m&&!!a&&e.jsx(C,{textStyle:"body2",color:"#F53C36",children:a})]}),e.jsx("input",{ref:S,type:"file",accept:".csv",style:{display:"none"},onChange:u=>{var h;(h=u.target.files)!=null&&h.length&&v(u.target.files[0])}})]})]}),e.jsx(ue,{})]})]})},he=async t=>{if(t.needTon&&(await z.accounts.getAccount(F.Address.parse(t.admin))).balance<BigInt(t.needTon))return t.errCb({title:"Not enough TON",text:"Top up balance and try again"}),!1;if(t.needJetton)try{const o=await z.accounts.getAccountJettonBalance(F.Address.parse(t.admin),F.Address.parse(t.jetton));if((o==null?void 0:o.balance)<BigInt((t==null?void 0:t.needJetton)||0))return t.errCb({title:"Not enough tokens",text:"Top up balance and try again"}),!1}catch(o){return t.errCb({title:"Error",text:(o==null?void 0:o.message)||""}),!1}return!0},H=t=>{const o="waiting";if(t.length===0)return o;const n=t.some(s=>s.airdrop_status==="not_deployed"),a=t.some(s=>s.airdrop_status==="lack_of_jettons"),r=t.some(s=>s.airdrop_status==="ready"),m=t.some(s=>s.airdrop_status==="blocked"),c=t.some(s=>!!s.ton_withdrawal_message),i=t.some(s=>!!s.jetton_withdrawal_message),d=t.some(s=>!s.jetton_withdrawal_message&&!s.ton_withdrawal_message);return n?"deploy":a?"topup":r?"ready":m&&i?"withdraw_jetton":m&&c?"withdraw_ton":m&&d?"withdraw_complete":m?"block":o},N=(t,o)=>o==="deploy"?{ton:t.filter(n=>n.airdrop_status==="not_deployed").reduce((n,a)=>n+parseFloat(a.deploy_message.amount),0)}:o==="topup"?{ton:t.filter(n=>n.airdrop_status==="lack_of_jettons"&&!!(n!=null&&n.top_up_message)).reduce((n,a)=>{var r;return n+parseFloat(((r=a==null?void 0:a.top_up_message)==null?void 0:r.amount)||"0")},0),jetton:t.filter(n=>n.airdrop_status==="lack_of_jettons").reduce((n,a)=>n+parseFloat((a==null?void 0:a.need_jettons)||"0"),0)}:o==="ready"?{ton:t.filter(n=>n.airdrop_status==="ready").reduce((n,a)=>n+parseFloat(a.block_message.amount),0)}:o==="withdraw_jetton"?{ton:t.filter(n=>n.airdrop_status==="blocked"&&!!n.jetton_withdrawal_message).reduce((n,a)=>n+parseFloat(a.jetton_withdrawal_message.amount),0)}:o==="withdraw_ton"?{ton:t.filter(n=>n.airdrop_status==="blocked"&&!!n.ton_withdrawal_message).reduce((n,a)=>n+parseFloat(a.ton_withdrawal_message.amount),0)}:null,ge=(t,o)=>{const n=[];return o==="deploy"?t.filter(a=>a.airdrop_status==="not_deployed").map(a=>({address:a.deploy_message.address,amount:a.deploy_message.amount,stateInit:a.deploy_message.state_init,payload:a.deploy_message.payload})):o==="topup"?t.filter(a=>a.airdrop_status==="lack_of_jettons"&&!!(a!=null&&a.top_up_message)).map(a=>({address:a.top_up_message.address,amount:a.top_up_message.amount,payload:a.top_up_message.payload})):o==="ready"?t.filter(a=>a.airdrop_status==="ready").map(a=>({address:a.block_message.address,amount:a.block_message.amount,payload:a.block_message.payload})):o==="withdraw_jetton"?t.filter(a=>a.airdrop_status==="blocked"&&!!a.jetton_withdrawal_message).map(a=>({address:a.jetton_withdrawal_message.address,amount:a.jetton_withdrawal_message.amount,payload:a.jetton_withdrawal_message.payload})):o==="withdraw_ton"?t.filter(a=>a.airdrop_status==="blocked"&&!!a.ton_withdrawal_message).map(a=>({address:a.ton_withdrawal_message.address,amount:a.ton_withdrawal_message.amount,payload:a.ton_withdrawal_message.payload})):n},y=t=>{const o=parseFloat(`${t}`);return new Intl.NumberFormat("en",{minimumFractionDigits:0,maximumFractionDigits:10}).format(o)},we=({id:t,airdropStore:o,updateType:n,hideEnableButton:a})=>{const r=o.airdrop$.value,m=o.distributors$.value,c=H(m),[i,d]=l.useState(!1),[s,j]=l.useState(!1),[x,k]=l.useState(!1),[f,T]=l.useState(c),S=G(),[I]=ae(),[w,A]=l.useState(m),[b,L]=l.useState(N(m,c)),v=l.useRef(null),u=async()=>{await o.loadDistributors(t).then(g=>{A(g),D()})};l.useEffect(()=>{(n==="ready"&&f==="ready"||n==="block"&&(f==="block"||f==="withdraw_jetton"||f==="withdraw_ton"))&&(j(!0),(async()=>await o.loadAirdrop(t))())},[f,n]),l.useEffect(()=>{(async()=>await u())()},[]),l.useEffect(()=>(v.current=setInterval(async()=>{await u()},2e3),()=>h()),[w,b,x]);const h=()=>{v.current&&clearInterval(v.current)},D=()=>{const g=H(w),U=N(w,g);L(U),f!==g&&(T(g),k(!1))},$=async()=>{if(f==="waiting"||x)return;const g=N(w,f),U=ge(w,f);if(await he({admin:r.admin,jetton:r.jetton.address,needTon:(g==null?void 0:g.ton)||0,needJetton:(g==null?void 0:g.jetton)||0,errCb:E=>{S({title:E.title,description:E.text,position:"bottom-left",duration:5e3,status:"error",isClosable:!0})}}))try{await I.sendTransaction({validUntil:Math.floor(new Date().getTime()/1e3+120),messages:U}),a&&a(),k(!0)}catch(E){console.error(E)}};if(r.status==="claim_active"||f==="withdraw_complete")return null;if(s||!w.length||f==="waiting"||!b||r.status==="need_deploy"&&f==="ready")return e.jsx(B,{children:e.jsx(O,{})});if(r.status==="claim_stopped")return e.jsxs(e.Fragment,{children:[e.jsx(_,{isLoading:x,onClick:()=>d(!0),variant:"secondary",children:"Complete Airdrop"}),e.jsx(me,{isOpen:i,onClose:()=>d(!1),onConfirm:()=>{d(!1),$()},title:"Complete Airdrop?",description:"This action cannot be canceled.",confirmButtonText:"Complete Airdrop"})]});if(r.status==="blocked")return e.jsxs(p,{wrap:"wrap",direction:"row",gap:"16px",children:[f==="withdraw_jetton"&&e.jsxs(_,{isLoading:x,onClick:$,children:["Withdraw ",r.jetton.symbol]}),e.jsx(_,{isDisabled:f==="withdraw_jetton",isLoading:f==="withdraw_ton"&&x,onClick:$,children:"Withdraw TON"})]});let M="Deploy",P=`You need ${y(F.fromNano(b.ton))} TON on your wallet`;return f==="topup"&&(M="Top Up",P=`You need ${y(F.fromNano(b.ton))} TON and ${y(b.jetton/10**parseFloat(r.jetton.decimals))} ${r.jetton.symbol} on your wallet`),e.jsxs(p,{align:"center",direction:"row",gap:"16px",children:[e.jsx(_,{isLoading:x,onClick:$,children:M}),e.jsx(C,{textStyle:"body2",color:"text.secondary",children:P})]})},_e=t=>{const o=t.airdropStore.airdrop$.value,n=G(),a=Z(),r=ee(),{open:m}=te(),c=()=>{n({title:"Connect Admin Wallet",description:"Please reconnect with admin wallet",position:"bottom-left",duration:5e3,status:"error",isClosable:!0})};return l.useEffect(()=>{a&&r&&r.account.address!==o.admin&&c()},[r,a]),!(r!=null&&r.account.address)||r.account.address!==o.admin?e.jsx(_,{flex:1,alignSelf:"flex-start",onClick:m,variant:"primary",children:"Connect Admin Wallet"}):e.jsx(we,{...t})},W=q(_e),R=t=>e.jsx(fe,{flex:"1",minW:"260px",bg:"background.contentTint",children:e.jsxs(p,{direction:"column",px:"16px",py:"12px",children:[e.jsx(C,{textStyle:"label2",color:"text.secondary",children:t.title}),e.jsx(V,{children:t.text})]})}),je=({airdropStore:t})=>{const o=t.airdrop$.value,n=t.distributors$.value;if(!n.length)return e.jsx(B,{children:e.jsx(O,{})});const a=n.reduce((d,s)=>d+((s==null?void 0:s.completed_claims)||0),0),r=n.reduce((d,s)=>d+s.recipients,0),m=n.reduce((d,s)=>d+parseFloat((s==null?void 0:s.claimed_amount)||"0"),0),c=n.reduce((d,s)=>d+parseFloat((s==null?void 0:s.jetton_balance)||"0"),0),i=n.reduce((d,s)=>d+parseFloat(s.accumulated_commission||"0"),0);return e.jsxs(p,{align:"center",wrap:"wrap",direction:"row",gap:"16px",children:[e.jsx(R,{title:"Number of claims",text:`${y(a)} / ${y(r)}`}),e.jsx(R,{title:"Claimed Jettons",text:`${y(m/10**parseFloat(o.jetton.decimals))}`}),e.jsx(R,{title:"Remaining Jettons",text:`${y(c/10**parseFloat(o.jetton.decimals))} ${o.jetton.symbol}`}),e.jsx(R,{title:"Profit",text:`${y(F.fromNano(i))} TON`})]})},ye=q(je),ve=()=>{const{id:t}=ne(),[o,n]=l.useState(!1),[a,r]=l.useState(!0),m=Y(),c=l.useMemo(()=>new ce({projectId:m}),[t]),i=c.airdrop$.value,d=c.distributors$.value;l.useEffect(()=>(t&&c.loadAirdrop(t),()=>{c.clearAirdrop()}),[t]);const s=async k=>{n(!0),await c.switchClaim(t,k),n(!1)};if(!c.airdrop$.isResolved||!i||!t)return e.jsx(B,{h:"300px",children:e.jsx(O,{})});let j="Upload the file with recipients",x="PREPARATION";return i.status==="need_deploy"&&(j="Create and top up distribution smart contracts by clicking the Deploy button."),i.status==="claim_active"&&(j="Airdrop is ready, you can pause claims or complete the distribution.",x="CLAIM ENABLED"),i.status==="claim_stopped"&&(j="Enable users to claim by clicking the Enable Claim button.",x="CLAIM DISABLED"),i.status==="blocked"&&(j="Distribution completed. You can withdraw the accumulated profit and remaining tokens using the Withdraw button.",x="FINISHED"),e.jsxs(oe,{display:"flex",flexDirection:"column",px:"0",children:[e.jsxs(p,{align:"flex-start",justify:"space-between",mb:"5",px:"6",children:[e.jsxs(se,{children:[e.jsxs(p,{align:"center",direction:"row",gap:"8px",children:[e.jsx(V,{mb:"1",children:i.name}),e.jsx(re,{textStyle:"label3",color:"accent.blue",bgColor:"color-mix(in srgb, currentColor 12%, transparent)",children:x})]}),e.jsx(C,{textStyle:"body2",color:"text.secondary",children:j})]}),e.jsx(ie,{})]}),e.jsx(le,{mb:"3"}),e.jsxs(p,{align:"flex-start",direction:"row",gap:"16px",px:"6",children:[e.jsxs(p,{direction:"column",gap:"24px",minW:"520px",maxW:"520px",children:[e.jsx(pe,{airdrop:i,id:t,distributors:d}),i.status==="need_file"&&e.jsx(xe,{id:t,airdropStore:c}),i.status==="need_deploy"&&e.jsx(W,{id:t,updateType:"ready",airdropStore:c}),(i.status==="claim_active"||i.status==="claim_stopped")&&e.jsxs(p,{direction:"row",gap:"16px",children:[a&&e.jsx(_,{isLoading:o,onClick:()=>s(i.status==="claim_active"?"disable":"enable"),variant:i.status==="claim_active"?"secondary":void 0,children:i.status==="claim_active"?"Disable Claim":"Enable Claim"}),e.jsx(W,{id:t,airdropStore:c,updateType:"block",hideEnableButton:()=>r(!1)})]})]}),i.status!=="need_file"&&i.status!=="need_deploy"&&e.jsxs(p,{direction:"column",gap:"16px",children:[e.jsx(ye,{airdropStore:c}),i.status==="blocked"&&e.jsx(W,{id:t,airdropStore:c}),e.jsxs(p,{wrap:"wrap",direction:"row",gap:"16px",children:[e.jsx(_,{onClick:()=>{window.open(`https://tonkeeper.github.io/airdrop-reference-dapp/v1/?airdropId=${t}`,"_blank")},variant:"secondary",children:"Test claim"}),e.jsx(_,{onClick:()=>{window.open("https://docs.tonconsole.com/tonconsole/jettons/airdrop","_blank")},children:"Documentation"})]})]})]})]})};export{ve as default};
