var f=Object.defineProperty;var y=(r,e,a)=>e in r?f(r,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[e]=a;var n=(r,e,a)=>y(r,typeof e!="symbol"?e+"":e,a);import{dA as m,bd as _,cB as u,cz as h,df as i,dM as g,dN as j}from"./index-BCN26Ft_.js";const I=async r=>{if(r.needTon&&(await m.accounts.getAccount(_.Address.parse(r.admin))).balance<BigInt(r.needTon))return r.errCb({title:"Not enough TON",text:"Top up balance and try again"}),!1;if(r.needJetton)try{const e=await m.accounts.getAccountJettonBalance(_.Address.parse(r.admin),_.Address.parse(r.jetton));if((e==null?void 0:e.balance)<BigInt((r==null?void 0:r.needJetton)||0))return r.errCb({title:"Not enough tokens",text:"Top up balance and try again"}),!1}catch(e){return r.errCb({title:"Error",text:(e==null?void 0:e.message)||""}),!1}return!0},b=r=>{const e="waiting";if(r.length===0)return e;const a=r.some(o=>o.airdrop_status==="not_deployed"),t=r.some(o=>o.airdrop_status==="lack_of_jettons"),s=r.some(o=>o.airdrop_status==="ready"),c=r.some(o=>o.airdrop_status==="blocked"),l=r.some(o=>!!o.ton_withdrawal_message),d=r.some(o=>!!o.jetton_withdrawal_message),p=r.some(o=>!o.jetton_withdrawal_message&&!o.ton_withdrawal_message);return a?"deploy":t?"topup":s?"ready":c&&d?"withdraw_jetton":c&&l?"withdraw_ton":c&&p?"withdraw_complete":c?"block":e},C=(r,e)=>e==="deploy"?{ton:r.filter(a=>a.airdrop_status==="not_deployed").reduce((a,t)=>a+parseFloat(t.deploy_message.amount),0)}:e==="topup"?{ton:r.filter(a=>a.airdrop_status==="lack_of_jettons"&&!!(a!=null&&a.top_up_message)).reduce((a,t)=>{var s;return a+parseFloat(((s=t==null?void 0:t.top_up_message)==null?void 0:s.amount)||"0")},0),jetton:r.filter(a=>a.airdrop_status==="lack_of_jettons").reduce((a,t)=>a+parseFloat((t==null?void 0:t.need_jettons)||"0"),0)}:e==="ready"?{ton:r.filter(a=>a.airdrop_status==="ready").reduce((a,t)=>a+parseFloat(t.block_message.amount),0)}:e==="withdraw_jetton"?{ton:r.filter(a=>a.airdrop_status==="blocked"&&!!a.jetton_withdrawal_message).reduce((a,t)=>a+parseFloat(t.jetton_withdrawal_message.amount),0)}:e==="withdraw_ton"?{ton:r.filter(a=>a.airdrop_status==="blocked"&&!!a.ton_withdrawal_message).reduce((a,t)=>a+parseFloat(t.ton_withdrawal_message.amount),0)}:null,D=(r,e)=>{const a=[];return e==="deploy"?r.filter(t=>t.airdrop_status==="not_deployed").map(t=>({address:t.deploy_message.address,amount:t.deploy_message.amount,stateInit:t.deploy_message.state_init,payload:t.deploy_message.payload})):e==="topup"?r.filter(t=>t.airdrop_status==="lack_of_jettons"&&!!(t!=null&&t.top_up_message)).map(t=>({address:t.top_up_message.address,amount:t.top_up_message.amount,payload:t.top_up_message.payload})):e==="ready"?r.filter(t=>t.airdrop_status==="ready").map(t=>({address:t.block_message.address,amount:t.block_message.amount,payload:t.block_message.payload})):e==="withdraw_jetton"?r.filter(t=>t.airdrop_status==="blocked"&&!!t.jetton_withdrawal_message).map(t=>({address:t.jetton_withdrawal_message.address,amount:t.jetton_withdrawal_message.amount,payload:t.jetton_withdrawal_message.payload})):e==="withdraw_ton"?r.filter(t=>t.airdrop_status==="blocked"&&!!t.ton_withdrawal_message).map(t=>({address:t.ton_withdrawal_message.address,amount:t.ton_withdrawal_message.amount,payload:t.ton_withdrawal_message.payload})):a},w=(r,e)=>{const a=b(e);let t="need_file";return a==="waiting"&&(t="need_file"),(a==="deploy"||a==="topup")&&(t="need_deploy"),a==="ready"&&r.clam_status==="opened"&&(t="claim_active"),a==="ready"&&r.clam_status==="closed"&&(t="claim_stopped"),(a==="block"||a==="withdraw_ton"||a==="withdraw_jetton"||a==="withdraw_complete")&&(t="blocked"),t},T=r=>{const e=parseFloat(`${r}`);return new Intl.NumberFormat("en",{minimumFractionDigits:0,maximumFractionDigits:10}).format(e)},F=(r,e=8)=>{if(r.length/2<e)return r;const a=r.slice(0,e),t=r.substring(r.length-e);return`${a}â€¦${t}`};function A(r){return r!=null&&r.length?r.every(e=>e.unlockTime||typeof e.fraction=="number"):!0}class S{constructor({projectId:e,airdrops:a}){n(this,"airdrop$",new u(null));n(this,"distributors$",new u([]));n(this,"projectId");n(this,"airdrops");n(this,"createAirdrop",async({adminAddress:e,address:a,fee:t,vesting:s,name:c})=>{if(!A(s))throw new Error("Vesting parameters are invalid: all items must have unlockTime and fraction fields");const l=await i.v2.newAirdrop({project_id:`${this.projectId}`},{admin:e,jetton:a,royalty_parameters:{min_commission:g.toNano(t).toString()},vesting_parameters:s!=null&&s.length?{unlocks_list:s.map(o=>({unlock_time:Math.floor(new Date(o.unlockTime).getTime()/1e3),fraction:o.fraction*100}))}:void 0}).then(({data:o})=>o),{data:d,error:p}=await j({query:{project_id:this.projectId},body:{api_id:l.id,name:c}});if(p)throw p;return this.airdrops.push(d.airdrop),d.airdrop.api_id});n(this,"loadAirdrop",this.airdrop$.createAsyncAction(async e=>{const a=await i.v2.getAirdropData({id:e,project_id:`${this.projectId}`}).then(({data:d})=>d),t=await i.v2.getDistributorsData({id:e,project_id:`${this.projectId}`}).then(({data:d})=>d.distributors);this.distributors$.value=t;const s=this.airdrops.find(d=>d.api_id===e);if(!s)throw new Error("Airdrop not found in local store");const c=w(a,t);return{...a,name:s.name,status:c}}));n(this,"loadDistributors",this.distributors$.createAsyncAction(async e=>await i.v2.getDistributorsData({id:e,project_id:`${this.projectId}`}).then(({data:t})=>t.distributors)));n(this,"switchClaim",async(e,a)=>{await(a==="enable"?i.v2.openClaim:i.v2.closeClaim)({id:e,project_id:`${this.projectId}`}).finally(()=>this.loadAirdrop(e))});h(this),this.projectId=e,this.airdrops=a}clearAirdrop(){this.airdrop$.clear(),this.distributors$.clear()}}class N{constructor({projectId:e}){n(this,"airdrop$",new u(null));n(this,"distributors$",new u([]));n(this,"projectId");n(this,"loadAirdrop",this.airdrop$.createAsyncAction(async e=>{const a=await i.v1.getAirdropData({id:e,project_id:`${this.projectId}`}).then(l=>l.data),t=await i.v1.getDistributorsData({id:e,project_id:`${this.projectId}`}).then(l=>l.data.distributors);this.distributors$.value=t;const s=w(a,t);return{...a,name:"Legacy airdrop",status:s}}));n(this,"loadDistributors",this.distributors$.createAsyncAction(async e=>await i.v1.getDistributorsData({id:e,project_id:`${this.projectId}`}).then(({data:t})=>t.distributors)));n(this,"switchClaim",async(e,a)=>{await(a==="enable"?i.v1.openClaim:i.v1.closeClaim)({id:e,project_id:`${this.projectId}`}).finally(()=>this.loadAirdrop(e))});h(this),this.projectId=e}clearAirdrop(){this.airdrop$.clear(),this.distributors$.clear()}}export{S as A,C as a,D as b,I as c,N as d,b as g,T as p,F as s};
